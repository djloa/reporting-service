image: docker:latest

services:
  - docker:dind

variables:
  AWS_DEFAULT_REGION: eu-north-1
  ECR_REGISTRY:  public.ecr.aws/i0g1s5d6
  ECR_REPOSITORY: reporting-service
  IMAGE_TAG: $CI_COMMIT_SHA

stages:
  - build
  - push
  - deploy

before_script:
  - apk add --no-cache python3 py3-pip
  - python3 -m venv venv
  - source venv/bin/activate
  - apk add aws-cli
  - aws --version
  - apk add --no-cache curl
  - curl -LO "https://storage.googleapis.com/kubernetes-release/release/$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)/bin/linux/amd64/kubectl"
  - chmod +x ./kubectl
  - mv ./kubectl /usr/local/bin/kubectl

build:
  stage: build
  script:
    - docker build -t $ public.ecr.aws/i0g1s5d6/:$IMAGE_TAG .
  only:
    - main

push:
  stage: push
  script:
    - $(aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY)
    - docker tag $ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
    - docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
  only:
    - main